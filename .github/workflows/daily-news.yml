name: Daily AI News

on:
  schedule:
    - cron: "0 23 * * *" # 毎日 23:00 UTC = 08:00 JST
  workflow_dispatch:
    inputs:
      target_date:
        description: "対象日 (YYYY-MM-DD形式、空欄で前日)"
        required: false
        default: ""

jobs:
  # ========================================
  # Phase 1: 10カテゴリで並列検索 (GLM-4.5)
  # webfetchメイン + web-search補足(1回/カテゴリ)
  # ========================================
  search:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      max-parallel: 10
      fail-fast: false
      matrix:
        category:
          - key: llm-models
            label: "LLM・基盤モデル"
            sites: "https://huggingface.co/blog, https://openai.com/blog, https://www.anthropic.com/news"
            search_query: "LLM new model release foundation model"
          - key: bigtech
            label: "Big Tech AI動向"
            sites: "https://blog.google/technology/ai/, https://openai.com/blog, https://www.anthropic.com/news, https://ai.meta.com/blog/"
            search_query: "OpenAI Google DeepMind Anthropic Meta Microsoft AI announcement"
          - key: ai-products
            label: "AIプロダクト・サービス"
            sites: "https://techcrunch.com/category/artificial-intelligence/, https://www.producthunt.com/topics/artificial-intelligence"
            search_query: "AI product launch new tool service release"
          - key: research
            label: "AI研究・論文"
            sites: "https://arxiv.org/list/cs.AI/recent, https://www.technologyreview.com/topic/artificial-intelligence/"
            search_query: "AI research paper breakthrough machine learning"
          - key: ai-infra
            label: "AIインフラ・ハードウェア"
            sites: "https://www.tomshardware.com/tag/ai, https://www.reuters.com/technology/artificial-intelligence/"
            search_query: "AI chip GPU NVIDIA data center infrastructure"
          - key: funding
            label: "AI資金調達・M&A"
            sites: "https://news.crunchbase.com/ai/, https://www.bloomberg.com/technology"
            search_query: "AI startup funding series acquisition merger"
          - key: policy
            label: "AI規制・政策・倫理"
            sites: "https://www.wired.com/tag/artificial-intelligence/, https://arstechnica.com/ai/"
            search_query: "AI regulation policy safety governance ethics"
          - key: japan
            label: "日本国内AI"
            sites: "https://www.itmedia.co.jp/aiplus/, https://ledge.ai/, https://ascii.jp/elem/000/004/ai/, https://www.watch.impress.co.jp/category/ai/"
            search_query: "日本 AI 生成AI ニュース 企業 導入"
          - key: ai-agents
            label: "AIエージェント・自動化"
            sites: "https://venturebeat.com/category/ai/, https://the-decoder.com/"
            search_query: "AI agent autonomous agentic workflow automation MCP"
          - key: ai-business
            label: "AI業界トレンド"
            sites: "https://www.theverge.com/ai-artificial-intelligence, https://www.cnbc.com/artificial-intelligence/"
            search_query: "AI industry trend market enterprise adoption generative AI"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install OpenCode
        run: curl -fsSL https://opencode.ai/install | bash

      - name: Set date variables
        run: |
          INPUT_DATE="${{ github.event.inputs.target_date }}"
          if [ -n "$INPUT_DATE" ]; then
            echo "YESTERDAY=$INPUT_DATE" >> $GITHUB_ENV
          else
            echo "YESTERDAY=$(TZ='Asia/Tokyo' date -d 'yesterday' +%Y-%m-%d)" >> $GITHUB_ENV
          fi

      - name: "Search: ${{ matrix.category.label }}"
        env:
          Z_AI_API_KEY: ${{ secrets.Z_AI_API_KEY }}
        run: |
          mkdir -p raw
          opencode run --model zai/glm-4.5 "
          あなたはAI・生成AIニュース専門の調査エージェントです。
          担当カテゴリ: **${{ matrix.category.label }}**
          対象日: ${{ env.YESTERDAY }}

          ## タスク
          対象日のAI関連ニュースを10件以上収集してください。

          ## 手順（この順番で実行すること）

          ### Step 1: ニュースサイト巡回（メイン・webfetch使用）
          以下のサイトをwebfetchで巡回し、${{ env.YESTERDAY }} の記事を収集:
          ${{ matrix.category.sites }}

          各サイトのページから記事タイトルとURLを抽出し、
          関連性の高い記事はさらにwebfetchで個別記事を読んで詳細を取得。

          ### Step 2: Web検索で補足（1回のみ・web-search使用）
          web-search_webSearchPrime を **1回だけ** 呼び出し、
          Step 1で拾えなかったニュースを補足:
          - search_query: \"${{ matrix.category.search_query }} ${{ env.YESTERDAY }}\"
          - location: \"us\"（日本国内カテゴリの場合は \"jp\"）
          - search_recency_filter: \"oneDay\"
          - 絶対に location を \"cn\" にしないこと
          - **web-searchは節約のため1回のみ。2回以上呼ばないこと。**

          ### Step 3: 結果をファイルに書き出し

          ## 出力
          ファイルパス: raw/${{ matrix.category.key }}.md

          以下のリッチフォーマットで全件を書き出してください:

          # ${{ matrix.category.label }} - ${{ env.YESTERDAY }}

          ---

          ## 1. ニュースタイトル（日本語）

          | 項目 | 内容 |
          |------|------|
          | ソース | [メディア名](URL) |
          | 公開日 | YYYY-MM-DD |
          | 重要度 | ⭐⭐⭐ / ⭐⭐ / ⭐ |

          ### 概要
          ニュースの全体像を3-4文で説明。

          ### 詳細ポイント
          - ポイント1: 具体的な数字や事実
          - ポイント2: 技術的な詳細や新規性
          - ポイント3: 関連する企業・人物

          ### なぜ重要か
          このニュースがAI業界にとってなぜ重要なのかを2-3文で解説。

          ### 関連キーワード
          キーワード1, キーワード2, キーワード3

          ---

          ## 2. ...

          ## ルール
          - 10件以上を目標に収集
          - 英語記事も日本語に翻訳して記載
          - 各ニュースにはソースURLを必ず含める
          - ${{ env.YESTERDAY }} 以外の古い記事は除外
          - web-search が使えない場合は webfetch のみで続行
          "

      - name: Upload search results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: news-${{ matrix.category.key }}
          path: raw/
          retention-days: 1

  # ========================================
  # Phase 2: 全結果をマージ・キュレーション
  # ========================================
  curate:
    needs: search
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install OpenCode
        run: curl -fsSL https://opencode.ai/install | bash

      - name: Set date variables
        run: |
          INPUT_DATE="${{ github.event.inputs.target_date }}"
          if [ -n "$INPUT_DATE" ]; then
            TARGET="$INPUT_DATE"
          else
            TARGET="$(TZ='Asia/Tokyo' date -d 'yesterday' +%Y-%m-%d)"
          fi
          echo "YESTERDAY=$TARGET" >> $GITHUB_ENV
          echo "MONTH_DIR=$(echo $TARGET | cut -d- -f1-2)" >> $GITHUB_ENV

      - name: Create directories
        run: |
          mkdir -p news/${{ env.MONTH_DIR }}
          mkdir -p raw

      - name: Download all search results
        uses: actions/download-artifact@v4
        with:
          path: raw/
          merge-multiple: true

      - name: Show collected data
        run: |
          echo "=== Collected files ==="
          ls -la raw/ 2>/dev/null || echo "No raw directory"
          echo "=== Line counts ==="
          wc -l raw/*.md 2>/dev/null || echo "No files found"

      - name: "Curate: merge and rank all news"
        env:
          Z_AI_API_KEY: ${{ secrets.Z_AI_API_KEY }}
        run: |
          opencode run --model zai/glm-4.5 "
          あなたはAI・生成AIニュースの編集長です。

          ## タスク
          raw/ ディレクトリに10カテゴリ分のニュース調査結果があります。
          全ファイルを読み込み、重複を排除・重要度でランキングし、
          最終的なデイリーニュースレポートを作成してください。

          ## 手順
          1. raw/ 内の全 .md ファイルを bash の cat コマンドで読み込む
          2. 重複記事を排除（同じニュースが異なるソースで報じられている場合は統合）
          3. 重要度⭐⭐⭐を優先し、全体から上位15-25件を厳選
          4. カテゴリ別に分類して最終レポートを作成
          5. news/${{ env.MONTH_DIR }}/${{ env.YESTERDAY }}.md に書き出す

          ## 出力フォーマット

          # AI News - ${{ env.YESTERDAY }}

          > 🔍 調査カテゴリ: 10 / 調査記事数: XX件 / 掲載: XX件

          ---

          ## 🔬 研究・技術

          ### 1. ニュースタイトル

          | 項目 | 内容 |
          |------|------|
          | ソース | [メディア名](URL) |
          | 重要度 | ⭐⭐⭐ |

          **概要**: ニュースの全体像を3-4文で説明。

          **詳細ポイント**:
          - ポイント1
          - ポイント2
          - ポイント3

          **なぜ重要か**: このニュースの意義を2-3文で解説。

          **関連キーワード**: キーワード1, キーワード2, キーワード3

          ---

          ## 🏢 企業・プロダクト
          （同じフォーマット）

          ## 💰 資金調達・M&A
          ## 📜 規制・政策・倫理
          ## 🇯🇵 国内ニュース
          ## 🤖 AIエージェント・自動化
          ## 🖥️ インフラ・ハードウェア

          ---

          ## 📊 本日のトレンド分析

          ### 主要テーマ
          今日のAI業界を貫く主要テーマを3-5つ挙げて各2-3文で解説。

          ### 注目企業・組織
          今日特に動きがあった企業や組織をリストアップ。

          ### 今後の展望
          今日のニュースから予測される今後の動向を3-5文でまとめる。

          ## ルール
          - カテゴリに該当記事がない場合はそのカテゴリを省略
          - 調査カテゴリ数・記事数・掲載数を冒頭に記載
          - 全て日本語で記載
          - 各ニュースにはソースURLを必ず含める
          - ファイルが既に存在する場合は上書きしない
          "

      - name: Clean up raw data
        run: rm -rf raw/

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add news/
          if git diff --cached --quiet; then
            echo "No new news files to commit"
          else
            git commit -m "📰 AI News: ${{ env.YESTERDAY }}"
            git push
          fi
