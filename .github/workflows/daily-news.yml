name: Daily AI News

on:
  schedule:
    - cron: "0 23 * * *" # 毎日 23:00 UTC = 08:00 JST
  workflow_dispatch:
    inputs:
      target_date:
        description: "対象日 (YYYY-MM-DD形式、空欄で前日)"
        required: false
        default: ""
      schedule_cron:
        description: "参考: cron式の変更はYAML直接編集が必要"
        required: false
        default: "30 0 * * * (現在: 毎日09:30 JST)"

jobs:
  # ========================================
  # Phase 1: 10カテゴリで並列検索 (GLM-4.5)
  # ========================================
  search:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      max-parallel: 10
      fail-fast: false
      matrix:
        category:
          - key: llm-models
            label: "LLM・基盤モデル"
            queries: "LLM foundation model release, 大規模言語モデル 新モデル, GPT Claude Gemini Llama update"
            sites: "https://huggingface.co/blog"
          - key: bigtech
            label: "Big Tech AI動向"
            queries: "OpenAI news, Google DeepMind, Anthropic Claude, Meta AI, Microsoft AI, Apple AI"
            sites: "https://openai.com/blog, https://blog.google/technology/ai/"
          - key: ai-products
            label: "AIプロダクト・サービス"
            queries: "AI product launch, AI tool release, AI SaaS new feature, 生成AI 新サービス リリース"
            sites: "https://techcrunch.com/category/artificial-intelligence/"
          - key: research
            label: "AI研究・論文"
            queries: "AI research paper, machine learning breakthrough, deep learning advance, AI 研究 論文 新手法"
            sites: "https://arxiv.org/list/cs.AI/recent"
          - key: ai-infra
            label: "AIインフラ・ハードウェア"
            queries: "AI chip GPU, NVIDIA AI, AI infrastructure cloud, AI半導体 GPU データセンター"
            sites: "https://www.anandtech.com/"
          - key: funding
            label: "AI資金調達・M&A"
            queries: "AI startup funding round series, AI acquisition merger, AI スタートアップ 資金調達 買収"
            sites: "https://news.crunchbase.com/"
          - key: policy
            label: "AI規制・政策・倫理"
            queries: "AI regulation policy government, EU AI Act, AI safety governance ethics, AI法規制 政策 倫理"
            sites: ""
          - key: japan
            label: "日本国内AI"
            queries: "日本 AI ニュース, 国内 生成AI 導入 事例, 日本企業 AI活用, AI 日本政府 方針"
            sites: "https://www.itmedia.co.jp/aiplus/, https://ledge.ai/"
          - key: ai-agents
            label: "AIエージェント・自動化"
            queries: "AI agent autonomous, agentic AI, AI automation workflow, AIエージェント 自動化 MCP"
            sites: ""
          - key: ai-business
            label: "AI業界トレンド・分析"
            queries: "AI industry trend analysis, AI market report, generative AI enterprise adoption, AI業界 動向 市場"
            sites: "https://venturebeat.com/category/ai/"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install OpenCode
        run: curl -fsSL https://opencode.ai/install | bash

      - name: Set date variables
        run: |
          INPUT_DATE="${{ github.event.inputs.target_date }}"
          if [ -n "$INPUT_DATE" ]; then
            echo "YESTERDAY=$INPUT_DATE" >> $GITHUB_ENV
          else
            echo "YESTERDAY=$(TZ='Asia/Tokyo' date -d 'yesterday' +%Y-%m-%d)" >> $GITHUB_ENV
          fi

      - name: "Search: ${{ matrix.category.label }}"
        env:
          Z_AI_API_KEY: ${{ secrets.Z_AI_API_KEY }}
        run: |
          mkdir -p raw
          opencode run --model zai/glm-4.5 "
          あなたはAI・生成AIニュース専門の調査エージェントです。
          担当カテゴリ: **${{ matrix.category.label }}**
          対象日: ${{ env.YESTERDAY }}

          ## タスク
          Web検索ツールを使い、${{ env.YESTERDAY }} の「${{ matrix.category.label }}」に関する
          AIニュースを **10件以上** 収集してください。

          ## 重要: web-search ツールの location パラメータ
          web-search_webSearchPrime を呼び出す際:
          - 英語クエリ → location: \"us\" を必ず指定
          - 日本語クエリ → location: \"jp\" を必ず指定
          - 絶対に \"cn\" を使わないこと

          ## 検索クエリ
          以下のクエリに「${{ env.YESTERDAY }}」を付加して検索:
          ${{ matrix.category.queries }}

          追加で関連するクエリも自分で考えて検索してください。

          ## フォールバック
          web-search が使えない場合は webfetch で以下を巡回:
          ${{ matrix.category.sites }}

          ## 出力
          ファイルパス: raw/${{ matrix.category.key }}.md

          以下のリッチフォーマットで全件を書き出してください:

          # ${{ matrix.category.label }} - ${{ env.YESTERDAY }}

          ---

          ## 1. ニュースタイトル（日本語）

          | 項目 | 内容 |
          |------|------|
          | ソース | [メディア名](URL) |
          | 公開日 | YYYY-MM-DD |
          | 重要度 | ⭐⭐⭐ / ⭐⭐ / ⭐ |

          ### 概要
          ニュースの全体像を3-4文で説明。何が起きたのか、誰が関わっているのかを明確に。

          ### 詳細ポイント
          - ポイント1: 具体的な数字や事実
          - ポイント2: 技術的な詳細や新規性
          - ポイント3: 関連する企業・人物
          - ポイント4: （あれば）競合や市場への影響

          ### なぜ重要か
          このニュースがAI業界にとってなぜ重要なのかを2-3文で解説。

          ### 関連キーワード
          キーワード1, キーワード2, キーワード3

          ---

          ## 2. ...

          ## ルール
          - 10件以上を目標に収集
          - 英語記事も日本語に翻訳して記載
          - 各ニュースにはソースURLを必ず含める
          - ${{ env.YESTERDAY }} 以外の古い記事は除外
          - web-search が途中で使えなくなったら webfetch に切り替えて続行
          "

      - name: Upload search results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: news-${{ matrix.category.key }}
          path: raw/
          retention-days: 1

  # ========================================
  # Phase 2: 全結果をマージ・キュレーション
  # ========================================
  curate:
    needs: search
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install OpenCode
        run: curl -fsSL https://opencode.ai/install | bash

      - name: Set date variables
        run: |
          INPUT_DATE="${{ github.event.inputs.target_date }}"
          if [ -n "$INPUT_DATE" ]; then
            TARGET="$INPUT_DATE"
          else
            TARGET="$(TZ='Asia/Tokyo' date -d 'yesterday' +%Y-%m-%d)"
          fi
          echo "YESTERDAY=$TARGET" >> $GITHUB_ENV
          echo "MONTH_DIR=$(echo $TARGET | cut -d- -f1-2)" >> $GITHUB_ENV

      - name: Create directories
        run: |
          mkdir -p news/${{ env.MONTH_DIR }}
          mkdir -p raw

      - name: Download all search results
        uses: actions/download-artifact@v4
        with:
          path: raw/
          merge-multiple: true

      - name: Show collected data
        run: |
          echo "=== Collected files ==="
          ls -la raw/ 2>/dev/null || echo "No raw directory"
          echo "=== Line counts ==="
          wc -l raw/*.md 2>/dev/null || echo "No files found"

      - name: "Curate: merge and rank all news"
        env:
          Z_AI_API_KEY: ${{ secrets.Z_AI_API_KEY }}
        run: |
          opencode run --model zai/glm-4.5 "
          あなたはAI・生成AIニュースの編集長です。

          ## タスク
          raw/ ディレクトリに10カテゴリ分のニュース調査結果があります。
          全ファイルを読み込み、重複を排除・重要度でランキングし、
          最終的なデイリーニュースレポートを作成してください。

          ## 手順
          1. raw/ 内の全 .md ファイルを bash の cat コマンドで読み込む
          2. 重複記事を排除（同じニュースが異なるソースで報じられている場合は統合）
          3. 重要度⭐⭐⭐を優先し、全体から上位15-25件を厳選
          4. カテゴリ別に分類して最終レポートを作成
          5. news/${{ env.MONTH_DIR }}/${{ env.YESTERDAY }}.md に書き出す

          ## 出力フォーマット

          # AI News - ${{ env.YESTERDAY }}

          > 🔍 調査カテゴリ: 10 / 調査記事数: XX件 / 掲載: XX件

          ---

          ## 🔬 研究・技術

          ### 1. ニュースタイトル

          | 項目 | 内容 |
          |------|------|
          | ソース | [メディア名](URL) |
          | 重要度 | ⭐⭐⭐ |

          **概要**: ニュースの全体像を3-4文で説明。

          **詳細ポイント**:
          - ポイント1
          - ポイント2
          - ポイント3

          **なぜ重要か**: このニュースの意義を2-3文で解説。

          **関連キーワード**: キーワード1, キーワード2, キーワード3

          ---

          ## 🏢 企業・プロダクト
          （同じフォーマットで続く）

          ## 💰 資金調達・M&A
          ## 📜 規制・政策・倫理
          ## 🇯🇵 国内ニュース
          ## 🤖 AIエージェント・自動化
          ## 🖥️ インフラ・ハードウェア

          ---

          ## 📊 本日のトレンド分析

          ### 主要テーマ
          今日のAI業界を貫く主要テーマを3-5つ挙げて各2-3文で解説。

          ### 注目企業・組織
          今日特に動きがあった企業や組織をリストアップして概要を記載。

          ### 今後の展望
          今日のニュースから予測される今後の動向を3-5文でまとめる。

          ## ルール
          - カテゴリに該当記事がない場合はそのカテゴリを省略
          - 調査カテゴリ数・記事数・掲載数を冒頭に記載
          - 全て日本語で記載
          - 各ニュースにはソースURLを必ず含める
          - ファイルが既に存在する場合は上書きしない
          "

      - name: Clean up raw data
        run: rm -rf raw/

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add news/
          if git diff --cached --quiet; then
            echo "No new news files to commit"
          else
            git commit -m "📰 AI News: ${{ env.YESTERDAY }}"
            git push
          fi
